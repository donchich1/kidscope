# === docker-compose.yml ===
version: "3.9"

services:
  bot:
    build:
      context: ./bot
    image: schoolbot-bot:latest
    container_name: schoolbot-bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DATA_FILE=/app/data/data.json
    volumes:
      - ./data:/app/data

  admin:
    build:
      context: ./admin
    image: schoolbot-admin:latest
    container_name: schoolbot-admin
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DATA_FILE=/app/data/data.json
      - STREAMLIT_SERVER_PORT=8501
    volumes:
      - ./data:/app/data
    ports:
      - "8501:8501"  # відкрий у браузері http://localhost:8501

# === .env.example ===
# Скопіюй у файл .env і заповни значення
BOT_TOKEN=7811760305:AAHtfRGM20Q9btxdWlmTBcdhJ2SrUZu5YjE
ADMIN_SECRET=secret123
# (не змінювати) шлях до спільного файлу даних
DATA_FILE=/app/data/data.json

# === bot/Dockerfile ===
FROM python:3.12-slim
WORKDIR /app
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
COPY kidscopetg.py ./
CMD ["python", "kidscopetg.py"]

# === bot/requirements.txt ===
python-telegram-bot==20.7

# === bot/kidscopetg.py (уривок з правкою DATA_FILE) ===
# ... на початку додай:
import os
from pathlib import Path
# ЗАМІНИ цей рядок:
# DATA_FILE = Path("data.json")
# НА:
DATA_FILE = Path(os.getenv("DATA_FILE", "data.json"))
# решта файлу без змін

# === admin/Dockerfile ===
FROM python:3.12-slim
WORKDIR /app
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
COPY admin_app.py ./
EXPOSE 8501
CMD ["python", "-m", "streamlit", "run", "admin_app.py", "--server.port=8501", "--server.address=0.0.0.0"]

# === admin/requirements.txt ===
streamlit==1.49.0
pandas==2.2.3
requests==2.32.3

# === admin/admin_app.py (уривок з правкою DATA_FILE) ===
# ... на початку додай:
import os
from pathlib import Path
# і змінюй default_path() так:
# раніше: return str(Path("data.json").resolve())
# тепер:

def default_path():
    p = Path(os.getenv("DATA_FILE", "data.json"))
    return str(p.resolve())
# решта файлу без змін

# === data/data.json (початковий шаблон) ===
{
  "students": {},
  "tg_links": {},
  "admins": []
}
